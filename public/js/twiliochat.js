var twiliochat=function(){function e(e){13===e.keyCode&&a()}function n(e){13===e.keyCode&&(D.currentChannel.sendMessage($(this).val()),e.preventDefault(),$(this).val(""))}function a(){var e=x.val();x.val(""),""!=e?(D.username=e,t(D.username,s)):alert("Username cannot be empty")}function t(e,n){$.post("/token",{identity:e,device:"browser"},null,"json").done(function(e){n(e.token)}).fail(function(e){console.log("Failed to fetch the Access Token with error: "+e)})}function s(e){D.accessManager=new Twilio.AccessManager(e),D.messagingClient=new Twilio.Chat.Client(e),D.messagingClient.initialize().then(function(){i(),D.loadChannelList(D.joinGeneralChannel),D.messagingClient.on("channelAdded",$.throttle(D.loadChannelList)),D.messagingClient.on("channelRemoved",$.throttle(D.loadChannelList)),D.messagingClient.on("tokenExpired",l)})}function l(){t(D.username,o)}function o(e){D.accessManager.updateToken(e.token)}function i(){$("#username-span").text(D.username),j.addClass("connected").removeClass("disconnected"),D.$messageList.addClass("connected").removeClass("disconnected"),G.addClass("connected").removeClass("disconnected"),A.addClass("with-shadow"),z.addClass("connected").removeClass("disconnected")}function r(e){return console.log("Initialized channel "+e.friendlyName),D.messagingClient.getChannelBySid(e.sid)}function c(e){return e.join().then(function(n){return console.log("Joined channel "+n.friendlyName),y(e),D.currentChannel=e,D.loadMessages(),n})}function d(){console.log(D.currentChannel.friendlyName+" ready."),D.currentChannel.on("messageAdded",D.addMessageToList),D.currentChannel.on("typingStarted",f),D.currentChannel.on("typingEnded",v),D.currentChannel.on("memberJoined",C),D.currentChannel.on("memberLeft",m),A.prop("disabled",!1).focus()}function h(e){return u().then(function(){return r(e)}).then(function(e){return c(e)}).then(d)}function u(){return D.currentChannel?D.currentChannel.leave().then(function(e){console.log("left "+e.friendlyName),e.removeListener("messageAdded",D.addMessageToList),e.removeListener("typingStarted",f),e.removeListener("typingEnded",v),e.removeListener("memberJoined",C),e.removeListener("memberLeft",m)}):Promise.resolve()}function C(e){g(e.identity+" joined the channel")}function m(e){g(e.identity+" left the channel")}function g(e){var n=$("<div>").addClass("col-md-12");n.loadTemplate("#member-notification-template",{status:e}),D.$messageList.append(n),p()}function f(e){B.text(e.identity+" is typing...")}function v(e){B.text("")}function p(){D.$messageList.scrollTop(D.$messageList[0].scrollHeight)}function y(e){var n=$(".channel-element").toArray().filter(function(n){return $(n).data().sid===e.sid});n=$(n),void 0===D.currentChannelContainer&&e.uniqueName===F&&(D.currentChannelContainer=n),D.currentChannelContainer.removeClass("selected-channel").addClass("unselected-channel"),n.removeClass("unselected-channel").addClass("selected-channel"),D.currentChannelContainer=n}function w(){D.messagingClient&&(E.addClass("showing").removeClass("not-showing"),M.addClass("showing").removeClass("not-showing"),q.focus())}function L(){E.addClass("not-showing").removeClass("showing"),M.addClass("not-showing").removeClass("showing"),q.val("")}function N(e){e.uniqueName===F&&(D.generalChannel=e);var n=$("<div>").addClass("row channel-row");n.loadTemplate("#channel-template",{channelName:e.friendlyName});var a=n.children().children().first();n.on("click",T),a.data("sid",e.sid),D.currentChannel&&e.sid===D.currentChannel.sid?(D.currentChannelContainer=a,a.addClass("selected-channel")):a.addClass("unselected-channel"),M.append(n)}function k(){D.currentChannel&&(D.currentChannel.sid!==D.generalChannel.sid?D.currentChannel.delete().then(function(e){console.log("channel: "+e.friendlyName+" deleted"),h(D.generalChannel)}):alert("You cannot delete the general channel"))}function T(e){var n=$(e.target).data().sid,a=D.channelArray.filter(function(e){return e.sid===n})[0];a!==D.currentChannel&&h(a)}function b(){u(),M.text(""),D.$messageList.text(""),channels=void 0,j.addClass("disconnected").removeClass("connected"),D.$messageList.addClass("disconnected").removeClass("connected"),G.addClass("disconnected").removeClass("connected"),A.removeClass("with-shadow"),z.addClass("disconnected").removeClass("connected")}var M,A,x,j,G,E,q,z,B,D={},F="general";$(document).ready(function(){D.$messageList=$("#message-list"),M=$("#channel-list"),A=$("#input-text"),x=$("#username-input"),j=$("#status-row"),G=$("#connect-panel"),E=$("#new-channel-input-row"),q=$("#new-channel-input"),z=$("#typing-row"),B=$("#typing-placeholder"),x.focus(),x.on("keypress",e),A.on("keypress",n),q.on("keypress",D.handleNewChannelInputKeypress),$("#connect-image").on("click",a),$("#add-channel-image").on("click",w),$("#leave-span").on("click",b),$("#delete-channel-span").on("click",k)});return D.handleNewChannelInputKeypress=function(e){13===e.keyCode&&(D.messagingClient.createChannel({friendlyName:q.val()}).then(L),$(this).val(""),e.preventDefault())},D.loadChannelList=function(e){void 0!==D.messagingClient?D.messagingClient.getPublicChannels().then(function(n){D.channelArray=D.sortChannelsByName(n.items),M.text(""),D.channelArray.forEach(N),"function"==typeof e&&e()}):console.log("Client is not initialized")},D.joinGeneralChannel=function(){console.log('Attempting to join "general" chat channel...'),D.generalChannel?(console.log("Found general channel:"),h(D.generalChannel)):D.messagingClient.createChannel({uniqueName:F,friendlyName:"General Channel"}).then(function(e){console.log("Created general channel"),D.generalChannel=e,D.loadChannelList(D.joinGeneralChannel)})},D.loadMessages=function(){D.currentChannel.getMessages(50).then(function(e){e.items.forEach(D.addMessageToList)})},D.addMessageToList=function(e){var n=$("<div>").addClass("row no-margin");n.loadTemplate($("#message-template"),{username:e.author,date:dateFormatter.getTodayDate(e.timestamp),body:e.body}),e.author===D.username&&n.addClass("own-message"),D.$messageList.append(n),p()},D.sortChannelsByName=function(e){return e.sort(function(e,n){return"General Channel"===e.friendlyName?-1:"General Channel"===n.friendlyName?1:e.friendlyName.localeCompare(n.friendlyName)})},D}();